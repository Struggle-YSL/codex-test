# 低代码平台架构规划（第一版详细稿）

> 技术基线：JDK21 + Spring Boot 3 + MyBatis-Plus + Sa-Token + Redis + Redisson + Warm-Flow + Vue3 + Element Plus
>
> 业务范围：表单 + 列表 + 流程 + 报表

---

## 1. 建设目标与范围定义

### 1.1 平台定位

本平台定位为：

- 面向中后台业务系统的低代码开发平台；
- 聚焦“数据录入 + 流程审批 + 查询分析”主链路；
- 以企业内部数字化场景为主（OA、采购、费用、合同、项目管理等）。

平台目标不是替代所有研发，而是：

- 用配置化能力承载 70%~80% 标准业务需求；
- 让研发聚焦复杂领域逻辑与集成能力；
- 缩短需求交付周期，降低重复开发成本。

### 1.2 本期范围（MVP）

本期严格聚焦 4 大域能力：

1. 表单（Form）
   - 表单设计（字段、布局、校验规则）
   - 运行时渲染（基于 schema）
   - 数据提交（草稿/提交/驳回重提）
2. 列表（List）
   - 查询条件配置、分页排序
   - 列展示、批量操作、导出
3. 流程（Flow）
   - 流程定义绑定业务对象
   - 待办/已办/我发起
   - 审批动作（同意/拒绝/转办）
4. 报表（Report）
   - 指标/维度配置
   - 常见图表展示（柱状/折线/饼图）
   - 条件筛选与基础缓存

### 1.3 非目标范围（本期暂不做）

- 暂不支持全场景 BPMN 高级编排（会签/子流程复杂模式可二期再做）；
- 暂不支持复杂 BI（跨主题多层钻取、实时 OLAP）；
- 暂不支持插件市场与第三方脚本任意执行；
- 暂不以多租户 SaaS 为本期硬目标（预留隔离能力）。

### 1.4 成功标准（验收口径）

功能成功标准：

- 能完成“设计表单 -> 发布 -> 提交流程 -> 列表查询 -> 报表统计”的端到端链路；
- 支持至少 20 种常用表单字段能力（含基础校验）；
- 支持组织级权限与数据权限过滤。

性能成功标准（建议值）：

- 95% 常规 API 响应时间 < 300ms；
- 列表查询（万级数据）首屏 < 1.5s；
- 报表常用查询（缓存命中）< 500ms。

交付成功标准：

- 第 1 期完成可用 MVP；
- 具备发布、回滚、审计、告警基础能力；
- 架构边界清晰，可平滑拆分服务。

---

## 2. 总体架构与演进策略

### 2.1 架构原则

1. 单体优先：先以最小复杂度达成业务价值。
2. 模块化解耦：用领域边界控制依赖，避免“大泥球单体”。
3. 配置驱动：设计态配置 + 运行态快照，降低编码成本。
4. 安全内建：认证、授权、数据权限、审计从第一期进入主链路。
5. 可演进：代码结构与通信方式提前按可拆分规范设计。

### 2.2 可拆分单体（Modular Monolith）

部署形态：

- 当前为单应用部署（一个进程、一个交付包）；
- 内部按业务域拆成模块，保持高内聚低耦合。

边界控制：

- 模块间通过“应用服务接口”交互；
- 禁止跨模块 Mapper 直连；
- 数据访问只允许在模块 infrastructure 内实现。

### 2.3 逻辑架构视图

#### 表现层

- 后端 REST API（Spring MVC）
- 前端设计器、运行端、管理端（Vue3 + Element Plus）

#### 应用层

- 用例编排（提交表单、触发流程、回写状态、刷新报表）
- 事务控制与幂等保障

#### 领域层

- 表单、列表、流程、报表、元数据等核心领域模型与规则

#### 基础设施层

- MyBatis-Plus 持久化
- Redis 缓存
- Redisson 锁
- Warm-Flow 工作流适配

### 2.4 演进到微服务的路径

演进触发条件（任一满足可启动拆分）：

- 单体发布窗口无法满足并行迭代；
- 特定域（如报表）资源消耗过大影响主业务；
- 团队规模增长导致模块冲突频繁。

建议拆分顺序：

1. 报表域（最先拆，计算压力独立）；
2. 流程域（与业务系统交互频繁，可独立治理）；
3. 表单/列表运行时（视业务复杂度决定）。

迁移方式：

- 先抽接口、再抽部署；
- 单体内接口保持契约稳定；
- 事件通知从本地消息表升级到 MQ。

---

## 3. 技术栈定版与选型说明

### 3.1 后端技术栈（已定）

- JDK 21（LTS）
- Spring Boot 3.x
- MyBatis-Plus
- Sa-Token
- Redis
- Redisson
- Warm-Flow

### 3.2 推荐补充组件（筛选结论）

1. 数据库：PostgreSQL（推荐）
   - 适合 schema 元数据与复杂查询；
   - JSONB 便于配置化存储；
   - 对报表统计支持优于通用轻量方案。

2. API 文档：SpringDoc OpenAPI
   - 自动生成接口文档，便于前后端协作与外部集成。

3. 对象映射：MapStruct
   - 降低 DTO/DO 转换模板代码。

4. 调度：Quartz（首期）
   - 支撑报表预计算、流程超时提醒、缓存刷新。

5. 文件存储：MinIO
   - 承载附件、导出文件、模板资产。

6. 可观测：Micrometer + Prometheus + Grafana（可分步）
   - 首期先落核心指标；后续扩展仪表盘和告警。

### 3.3 前端技术栈（已定）

- Vue 3 + TypeScript + Vite
- Element Plus
- Pinia
- Vue Router
- Axios
- ECharts

### 3.4 关键取舍说明

- 为什么不用微服务起步：
  - 低代码平台前期需求变化快，单体更有利于迭代效率。
- 为什么用 MyBatis-Plus：
  - CRUD 生产效率高，可控性强，便于加入数据权限注入。
- 为什么用 Warm-Flow：
  - 与“表单+审批”场景契合，可快速打通流程能力。
- 为什么优先 PostgreSQL：
  - 兼顾事务、复杂查询、配置存储、统计扩展能力。

---

## 4. 后端分层与模块规划（可拆分）

### 4.1 Maven 多模块建议

- lowcode-boot：启动与装配
- lowcode-common：通用能力（异常、返回、工具、审计）
- lowcode-auth：认证授权
- lowcode-meta：元数据管理
- lowcode-form：表单域
- lowcode-list：列表域
- lowcode-flow：流程域
- lowcode-report：报表域
- lowcode-runtime：运行时引擎
- lowcode-infra：基础设施适配

### 4.2 模块职责边界

- auth
  - 用户、角色、权限、数据权限策略
- meta
  - 应用、模型、字段、schema、发布版本
- form
  - 表单设计与提交规则
- list
  - 列表查询 DSL 与批量操作
- flow
  - 流程定义、实例、审批动作
- report
  - 指标维度、图表配置、统计查询
- runtime
  - schema 解析与渲染执行、规则引擎入口
- infra
  - Redis/Redisson/文件/调度/消息适配

### 4.3 模块内部四层结构

每个业务模块统一采用：

1. interfaces
   - Controller、Request/Response DTO、参数校验
2. application
   - 用例服务、事务边界、跨聚合编排
3. domain
   - 实体、值对象、聚合根、领域服务、规则
4. infrastructure
   - Mapper、Repository 实现、第三方适配器

### 4.4 依赖规则（必须执行）

- interfaces 只能依赖 application；
- application 可依赖 domain 与仓储接口；
- domain 不依赖任何框架实现；
- infrastructure 实现 domain/application 定义的接口；
- 禁止任何模块跨越 application 直接访问他域 infrastructure。

### 4.5 关键横切能力

统一在 common/infra 处理：

- 全局异常与错误码体系
- 统一审计日志
- 统一幂等策略
- 统一缓存 Key 规范
- 统一权限拦截与数据权限注入

---

## 5. 四大业务域架构设计（下一章节详细展开）
- 5.1 表单域
- 5.2 列表域
- 5.3 流程域
- 5.4 报表域
- 5.5 域间协同链路

## 6. 元数据与运行时模型（下一章节详细展开）
- 6.1 元数据模型
- 6.2 发布快照
- 6.3 灰度与回滚
- 6.4 兼容策略

## 7. 数据存储与缓存策略（下一章节详细展开）
- 7.1 数据分层
- 7.2 索引与归档
- 7.3 Redis 分层缓存
- 7.4 Redisson 锁场景

## 8. 安全与权限体系（下一章节详细展开）
- 8.1 Sa-Token
- 8.2 RBAC
- 8.3 数据权限
- 8.4 审计与安全基线

## 9. 前端工程与设计器规划（下一章节详细展开）
- 9.1 工程模块
- 9.2 动态渲染
- 9.3 协议与组件注册
- 9.4 流程报表交互规范

## 10. 非功能设计（下一章节详细展开）
- 10.1 性能
- 10.2 稳定性
- 10.3 可观测性
- 10.4 可运维性

## 11. 实施路线图（下一章节详细展开）
- 11.1 第一期
- 11.2 第二期
- 11.3 第三期
- 11.4 里程碑与验收

## 12. 风险清单与治理策略（下一章节详细展开）
- 12.1 范围管理
- 12.2 安全风险
- 12.3 性能风险
- 12.4 技术债风险

## 13. 交付物清单（下一章节详细展开）
- 13.1 详细架构设计
- 13.2 数据库脚本
- 13.3 OpenAPI 清单
- 13.4 开发联调规范
- 13.5 MVP 演示链路

---

## 附录 A：待你确认（决策项）
- A.1 PostgreSQL 是否作为默认主库（建议：是）
- A.2 Warm-Flow 首期采用默认模型还是直接扩展审批规则
- A.3 报表首期范围：基础图表 vs 多维钻取
- A.4 多租户是否一期进入（建议：预留，二期落地）
